name: Build and Test

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest

    strategy:
      matrix:
        build-type: [Release, Debug]

    steps:
      - name: Checkout plugin repository
        uses: actions/checkout@v4
        with:
          path: plugin
          submodules: recursive

      - name: Checkout Open Ephys GUI
        uses: actions/checkout@v4
        with:
          repository: open-ephys/plugin-GUI
          path: plugin-GUI
          submodules: recursive

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Cache GUI dependencies
        uses: actions/cache@v4
        with:
          path: |
            plugin-GUI/Build
            plugin-GUI/installed_libs
          key: ${{ runner.os }}-gui-${{ hashFiles('plugin-GUI/CMakeLists.txt') }}-${{ matrix.build-type }}
          restore-keys: |
            ${{ runner.os }}-gui-

      - name: Configure Open Ephys GUI
        run: |
          cd plugin-GUI
          cmake -B Build -G "Visual Studio 17 2022" -A x64 -DBUILD_TESTS=ON

      - name: Build Open Ephys GUI
        run: |
          cd plugin-GUI
          cmake --build Build --config ${{ matrix.build-type }} -j4

      - name: Configure plugin
        run: |
          cd plugin
          cmake -B Build -G "Visual Studio 17 2022" -A x64 -DGUI_BASE_DIR="${{ github.workspace }}/plugin-GUI"

      - name: Build plugin
        run: |
          cd plugin
          cmake --build Build --config ${{ matrix.build-type }} -j4

      - name: Run tests
        run: |
          cd plugin/Build
          ctest -C ${{ matrix.build-type }} --output-on-failure --verbose
        continue-on-error: false

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-windows-${{ matrix.build-type }}
          path: plugin/Build/test-results/
          if-no-files-found: ignore

      - name: Upload plugin artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: triggered-avg-plugin-windows-${{ matrix.build-type }}
          path: plugin/Build/${{ matrix.build-type }}/TriggeredAvg.dll
          if-no-files-found: error

  build-linux:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        build-type: [Release, Debug]

    steps:
      - name: Checkout plugin repository
        uses: actions/checkout@v4
        with:
          path: plugin
          submodules: recursive

      - name: Checkout Open Ephys GUI
        uses: actions/checkout@v4
        with:
          repository: open-ephys/plugin-GUI
          path: plugin-GUI
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            pkg-config \
            libgl1-mesa-dev \
            libx11-dev \
            libxext-dev \
            libxinerama-dev \
            libasound2-dev \
            libfreetype6-dev \
            libcurl4-openssl-dev \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev

      - name: Cache GUI dependencies
        uses: actions/cache@v4
        with:
          path: |
            plugin-GUI/Build
            plugin-GUI/installed_libs
          key: ${{ runner.os }}-gui-${{ hashFiles('plugin-GUI/CMakeLists.txt') }}-${{ matrix.build-type }}
          restore-keys: |
            ${{ runner.os }}-gui-

      - name: Configure Open Ephys GUI
        run: |
          cd plugin-GUI
          cmake -B Build -DCMAKE_BUILD_TYPE=${{ matrix.build-type }} -DBUILD_TESTS=ON

      - name: Build Open Ephys GUI
        run: |
          cd plugin-GUI
          cmake --build Build --config ${{ matrix.build-type }} -j$(nproc)

      - name: Configure plugin
        run: |
          cd plugin
          cmake -B Build -DCMAKE_BUILD_TYPE=${{ matrix.build-type }} -DGUI_BASE_DIR="${{ github.workspace }}/plugin-GUI" -DBUILD_TESTS=ON

      - name: Build plugin
        run: |
          cd plugin
          cmake --build Build --config ${{ matrix.build-type }} -j$(nproc)

      - name: Run tests
        run: |
          cd plugin/Build
          ctest --output-on-failure --verbose
        continue-on-error: false

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-linux-${{ matrix.build-type }}
          path: plugin/Build/test-results/
          if-no-files-found: ignore

      - name: Upload plugin artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: triggered-avg-plugin-linux-${{ matrix.build-type }}
          path: plugin/Build/libtriggered-avg.so
          if-no-files-found: error
